## Анализ профилей памяти

### Общая статистика

**base.pprof** (базовый профиль):
- Общий объем используемой памяти: **6152.18 kB** (~6 MB)
- Время создания: 2025-11-23 12:48:04 MSK

**result.pprof** (результирующий профиль):
- Общий объем используемой памяти: **5651.52 kB** (~5.5 MB)
- Время создания: 2025-11-23 12:58:27 MSK
- Изменение: **-500.66 kB** (уменьшение на ~8%)

### Основные потребители памяти

#### base.pprof (топ-5):
1. `runtime.allocm` — 2052 kB (33.35%) — выделение памяти для новых M (машин)
2. `net.newFD` — 1024.62 kB (16.65%) — создание файловых дескрипторов сети
3. `github.com/jackc/pgx/v5/pgconn/ctxwatch.(*ContextWatcher).Watch.func1` — 1024.09 kB (16.65%) — контекстный watcher для PostgreSQL
4. `unicode.map.init.2` — 515.19 kB (8.37%) — инициализация таблиц Unicode
5. `runtime.malg` — 512.22 kB (8.33%) — выделение памяти для горутин

#### result.pprof (топ-5):
1. `runtime.allocm` — 3591 kB (63.54%) — увеличение на 75% (1539 kB)
2. `encoding/xml.map.init.0` — 521.05 kB (9.22%) — новая инициализация XML-карт
3. `strings.(*Replacer).build` — 515.19 kB (9.12%) — построение Replacer для строк
4. `runtime.malg` — 512.22 kB (9.06%) — без изменений
5. `context.(*cancelCtx).Done` — 512.05 kB (9.06%) — контексты отмены

### Изменения между профилями

#### Увеличилось:
- `runtime.allocm`: +1539 kB (с 2052 kB до 3591 kB) — больше потоков выполнения
- `encoding/xml.map.init.0`: +521.05 kB — новая инициализация XML
- `strings.(*Replacer).build`: +515.19 kB — новая инициализация Replacer
- `context.(*cancelCtx).Done`: +512.05 kB — больше контекстов отмены

#### Уменьшилось:
- `net.newFD`: -1024.62 kB — освобождение сетевых дескрипторов
- `github.com/jackc/pgx/v5/pgconn/ctxwatch.(*ContextWatcher).Watch.func1`: -1024.09 kB — освобождение watcher'а PostgreSQL
- `unicode.map.init.2`: -515.19 kB — освобождение таблиц Unicode
- `github.com/labstack/echo/v4.(*Router).add`: -512.02 kB — освобождение роутера Echo
- `golang.org/x/sys/windows.(*LazyDLL).NewProc`: -512.02 kB — освобождение DLL-процедур

### Выводы

1. Общее потребление памяти снизилось на ~8% (с 6.15 MB до 5.65 MB).
2. Увеличилось использование `runtime.allocm` (+75%), что указывает на большее число потоков выполнения (M).
3. В result.pprof появились новые инициализации:
   - XML-карты (encoding/xml)
   - Replacer для строк (strings)
   - Контексты отмены (context)
4. Освобождены ресурсы:
   - Сетевые дескрипторы (Echo сервер)
   - PostgreSQL watcher
   - Роутер Echo
   - Windows DLL-процедуры

### Рекомендации

1. Мониторить рост `runtime.allocm` — возможно, слишком много горутин или потоков.
2. Проверить необходимость инициализации XML и Replacer — возможно, их можно отложить или убрать.
3. Общее снижение памяти — положительный результат, но стоит отслеживать динамику `runtime.allocm`.

Профили показывают, что приложение освободило часть ресурсов (сеть, БД), но увеличило использование runtime-ресурсов для потоков выполнения.